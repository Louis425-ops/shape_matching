# 螺母检测系统使用指南

## 🎯 功能说明

这个系统可以：
- 根据单个螺母图片训练识别模板
- 在包含多个螺母的图片中自动检测所有螺母
- 输出每个螺母的位置坐标和置信度
- 在原图上画框标注检测结果
- 自动统计检测到的螺母数量

## 📋 准备工作

### 1. 编译检测程序

```bash
cd /home/zby/Desktop/shape_based_matching
g++ -I. -I./MIPP/ -fopenmp -march=native -O3 -std=c++14 \
    line2Dup.cpp nut_detection.cpp -o nut_detector \
    `pkg-config --cflags --libs opencv4`
```

### 2. 准备图片

你需要准备两张图片：
- **模板图片**：包含单个螺母的清晰图片
- **测试图片**：包含多个螺母的图片

#### 图片要求：
- ✅ **清晰度**：图片要清晰，螺母边缘明显
- ✅ **对比度**：螺母与背景要有足够对比度
- ✅ **尺寸**：建议模板图片中螺母直径至少50像素
- ✅ **格式**：支持 jpg、png、bmp 等常见格式

## 🚀 使用步骤

### 第一步：训练模板 (必须先执行)

```bash
./nut_detector <模板图片> <测试图片> <输出图片> train
```

**示例：**
```bash
./nut_detector single_nut.jpg many_nuts.jpg result.jpg train
```

**训练过程说明：**
- 系统会自动生成不同角度(0°-360°,步长30°)和缩放(80%-120%,步长10%)的模板
- 总共会生成 13个缩放 × 12个角度 = 156个模板变换
- 训练完成后会生成两个文件：
  - `nut_nut_templ.yaml`：模板特征文件
  - `nut_info.yaml`：模板信息文件

### 第二步：检测螺母

```bash
./nut_detector <模板图片> <测试图片> <输出图片> test [相似度阈值] [NMS阈值]
```

**基础使用：**
```bash
./nut_detector single_nut.jpg many_nuts.jpg result.jpg test
```

**高级参数调节：**
```bash
./nut_detector single_nut.jpg many_nuts.jpg result.jpg test 85 0.3
```

### 参数说明

| 参数 | 说明 | 默认值 | 建议范围 |
|------|------|--------|----------|
| 相似度阈值 | 检测置信度阈值，越高越严格 | 80 | 70-95 |
| NMS阈值 | 重叠检测去除阈值，越小越严格 | 0.3 | 0.2-0.5 |

## 📊 结果输出

### 控制台输出示例：
```
=== 检测结果详情 ===
 序号    X坐标    Y坐标    相似度    模板ID
--------------------------------------------------
    1       156       234      92.5%        23
    2       445       198      88.7%        45
    3       123       567      85.2%        12

=== 检测统计 ===
检测到螺母数量: 3 个
平均置信度: 88.8%
结果已保存到: result.jpg
```

### 结果图片：
- 每个检测到的螺母会用彩色矩形框标出
- 框上方显示编号和置信度
- 自动保存到指定的输出路径

## 🔧 参数调优指南

### 如果检测不到螺母：
1. **降低相似度阈值**：从80降到70或60
   ```bash
   ./nut_detector single_nut.jpg many_nuts.jpg result.jpg test 70
   ```

2. **检查图片质量**：
   - 确保螺母边缘清晰
   - 检查光照是否均匀
   - 确保螺母与背景有足够对比度

3. **重新训练模板**：
   - 使用更清晰的模板图片
   - 确保模板图片中螺母完整

### 如果检测到太多重复：
1. **提高相似度阈值**：从80提高到85或90
   ```bash
   ./nut_detector single_nut.jpg many_nuts.jpg result.jpg test 90
   ```

2. **调整NMS阈值**：降低重叠阈值
   ```bash
   ./nut_detector single_nut.jpg many_nuts.jpg result.jpg test 80 0.2
   ```

### 如果漏检部分螺母：
1. **降低相似度阈值**和**提高NMS阈值**：
   ```bash
   ./nut_detector single_nut.jpg many_nuts.jpg result.jpg test 75 0.4
   ```

2. **使用更具代表性的模板**：选择典型的螺母作为模板

## 📁 文件结构

完成训练和检测后，目录下会有：

```
shape_based_matching/
├── nut_detector              # 编译的可执行文件
├── nut_detection.cpp          # 源代码
├── nut_nut_templ.yaml        # 模板特征文件
├── nut_info.yaml             # 模板信息文件
├── single_nut.jpg            # 你的模板图片
├── many_nuts.jpg             # 你的测试图片
└── result.jpg                # 检测结果图片
```

## 🎨 实际使用示例

假设你有以下文件：
- `template_nut.jpg`：单个螺母模板
- `workshop_nuts.jpg`：工作台上的多个螺母

### 完整操作流程：

```bash
# 1. 编译程序
g++ -I. -I./MIPP/ -fopenmp -march=native -O3 -std=c++14 \
    line2Dup.cpp nut_detection.cpp -o nut_detector \
    `pkg-config --cflags --libs opencv4`

# 2. 训练模板 (只需执行一次)
./nut_detector template_nut.jpg workshop_nuts.jpg result.jpg train

# 3. 执行检测
./nut_detector template_nut.jpg workshop_nuts.jpg result.jpg test

# 4. 查看结果
# - 控制台会显示详细检测信息
# - result.jpg 包含标注后的图片
```

## 🔍 常见问题解决

### Q1: 编译失败
**解决方案：**
- 确保安装了OpenCV：`sudo apt install libopencv-dev`
- 检查MIPP目录是否存在
- 确保line2Dup.cpp文件完整

### Q2: 训练时报错 "feature size too large"
**解决方案：**
- 模板图片太小，螺母直径至少50像素
- 或者降低特征数量，修改代码中的 `num_feature`

### Q3: 检测结果不准确
**解决方案：**
1. 先检查模板图片质量
2. 调整相似度阈值
3. 重新训练模板
4. 确保测试图片中螺母与模板相似

### Q4: 程序运行后没有显示窗口
**解决方案：**
- 这是正常的，结果已保存到图片文件
- 如需查看，用图片查看器打开输出文件

## 💡 性能优化建议

1. **图片预处理**：
   - 调整对比度和亮度
   - 适当缩放图片大小（太大会影响速度）

2. **参数优化**：
   - 根据实际效果调整相似度阈值
   - 合理设置NMS阈值避免漏检

3. **硬件优化**：
   - 程序已启用OpenMP多线程
   - 使用SIMD指令集加速

现在你可以开始试验了！记得先准备好两张图片，然后按照步骤操作。